
### Спецификация сервиса отправки уведомлений

#### Общая информация
Сервис предназначен для отправки уведомлений пользователям через различные каналы: email, push-уведомления, Telegram и VK.

### Форматы запроса

**Для подписки отпрвки сообщения**:

```json
{
  "user_id": "uuid",
  "service": "email|push|telegram|vk",
  "subject": "Subject of the message",
  "type": "notification|error|critical|deadline|service",
  "message": "Message content"
}
```
- **Параметры**:
  - `user_id`: Уникальный идентификатор пользователя.
  - `service`: Метод отправки сообщения
  - `subject`: Тема запроса
  - `type`: Тип уведомления
  - `message`: Текст уведомления.

**Для подписки на push**:

```json
{
  "user_id": "uuid",
  "device_id": "device_unique_id"
}
```

- **Параметры**:
  - `user_id`: Уникальный идентификатор пользователя.
  - `device_id`: Уникальный идентификатор устройства (например, FCM токен для Android).

### Список роутеров

1. **/notifications/send**
   - **Описание**: Отправка уведомлений в указанный сервис в зависимости от переданного параметра `service`.
   - **Метод**: `POST`
   - **Форматы ответов**: 
     - `200 OK`: `{ "status": "success", "message": "Notification sent successfully." }`
     - `400 Bad Request`: `{ "status": "error", "message": "Invalid request format or service." }`
     - `404 Not Found`: `{ "status": "error", "message": "User not found or UUID not linked." }`
     - `500 Internal Server Error`: `{ "status": "error", "message": "Failed to send notification." }`
     - 
2. **/notifications/subscribe**
  - **Описание**: Подписка к push-уведомлениям мобильного приложения.
  - **Метод**: `POST`
  - **Форматы ответов**:
    - `200 OK`: `{ "status": "success", "message": "Successfully subscribed to notifications." }`
    - `400 Bad Request`: `{ "status": "error", "message": "Invalid request format or parameters." }`
    - `409 Conflict`: `{ "status": "error", "message": "Device already registered with a different user." }`
    - `404 Not Found`: `{ "status": "error", "message": "User not found." }`
    - `500 Internal Server Error`: `{ "status": "error", "message": "Failed to process the subscription." }`

### Типы уведомлений

| Тип уведомления | Описание                                     | Доступные роли          |
|-----------------|----------------------------------------------|-------------------------|
| notification     | Обычные уведомления                          | Все роли                |
| error            | Уведомления об ошибках                       | Администраторы                |
| critical         | Критические уведомления                      |  Администраторы, Менеджеры |
| deadline         | Уведомления о предстоящих дедлайнах         | Администраторы, Менеджеры                |
| service          | Уведомления о статусе сервиса               | Администраторы          |

#### Форматы сообщений по сервисам

1. **Email**
   - **Тема**: `{subject} | {type}`
   - **Тело**: `Message content`

2. **Push**
   - **Заголовок**: `{subject}`
   - **Тело**: `Message content`

3. **Telegram и VK**
   - **Формат**:
     ```
     Тема: {subject} | {type}
     Message content
     ```


### Привязка пользователя к сервису через Telegram и VK

Привязка пользователя к сервису для получения уведомлений через Telegram и VK осуществляется с помощью специальной ссылки к боту, содержащей query-параметры. Это позволяет пользователю легко подключить свой аккаунт к системе.

#### Формат ссылки

1. **Telegram**
   - **Формат ссылки**:
     ```
     https://t.me/YourBotName?start={uuid}
     ```
   - **Описание**: 
     - `YourBotName` — имя вашего Telegram-бота.
     - `{uuid}` — уникальный идентификатор пользователя, который будет использоваться для привязки его аккаунта к системе.

2. **VK**
   - **Формат ссылки**:
     ```
     https://vk.com/your_vk_bot?act=subscribe&user_id={uuid}
     ```
   - **Описание**:
     - `your_vk_bot` — имя вашего VK-бота.
     - `{uuid}` — уникальный идентификатор пользователя, который будет использоваться для привязки его аккаунта к системе.

#### Процесс привязки через бота

1. **Отправка ссылки пользователю**: 
   - Пользователь получает ссылку на привязку через интерфейс приложения или в виде уведомления.

2. **Переход по ссылке**:
   - Пользователь переходит по предоставленной ссылке, что открывает чат с ботом в Telegram или VK.

3. **Обработка запроса ботом**:
   - Бот получает `user_id` из query-параметра и инициирует процесс привязки.
   - Если пользователь уже привязан к другому аккаунту, бот уведомляет его об этом и предлагает изменить привязку.

4. **Подтверждение привязки**:
   - Бот запрашивает подтверждение у пользователя на привязку его аккаунта к системе.
   - После подтверждения бот обновляет данные пользователя в базе и связывает его аккаунт с указанным `user_id`.

5. **Уведомление о завершении**:
   - После успешной привязки бот отправляет пользователю сообщение о том, что привязка завершена, и уведомляет о доступных типах уведомлений.

### Метод подписки мобильного приложения к уведомлениям

#### Описание метода

Метод подписки мобильного приложения позволяет пользователям получать уведомления через выбранный сервис (например, push-уведомления). Этот процесс включает в себя регистрацию устройства и его идентификатора в системе.

#### Процесс подписки

1. **Отправка запроса**:
   - Мобильное приложение отправляет HTTP POST запрос на эндпоинт `/notifications/subscribe/` с указанным форматом запроса.

2. **Валидация данных**:
   - Сервер проверяет корректность параметров запроса:
     - Убедиться, что `user_id` существует в базе данных.
     - Проверить, что `device_id` уникален для данного пользователя.

3. **Регистрация устройства**:
   - Если все параметры валидны, сервер добавляет или обновляет запись о `device_id` в базе данных, связывая его с `user_id`.

4. **Подписка на уведомления**:
   - Если пользователь уже подписан на уведомления но с другого устройства, сервер добавляет информацию с новым `device_id`. 


#### Хранение данных

- **Привязвка клиентов к сервисам**: Все привязыки к сервисам будут сохраняться для последующего анализа и аудита. Каждая каждая запись должна включать:
    - `id` (связь с user_id)
  - `service`
  - `service_user_id` (id пользователя в сервисе)
  - `timestamp`

- **Привязвка клиентов к девайсам**: Все привязыки к девайсам будут сохраняться для последующего анализа и аудита. Каждая каждая запись должна включать:
    - `id` (связь с user_id)
  - `device_id` (уникальный илентификатор сети)
  - `timestamp`

- **История уведомлений**: Все отправленные уведомления будут сохраняться для последующего анализа и аудита. Каждое уведомление должно включать:
  - `id` (связь с user_id)
  - `service`
  - `subject`
  - `type`
  - `message`
  - `timestamp`

- **История уведомлений push**: Все отправленные уведомления через push будут сохраняться для последующего анализа и аудита. Каждое уведомление должно включать:
  - `id` (связь с user_id)
  - `subject`
  - `type`
  - `message`
  - `timestamp`

- **История изменений привязки клиентов к сервисам**: Все изменения привязвки к сервисам будут сохраняться для последующего анализа и аудита. Каждая запись об изменении должна включать:
  - `id` (связь с user_id)
  - `service`
  - `old_service_user_id`
  - `new_service_user_id`
  - `timestamp`
  
- **История изменений привязки девайса к клиенту**: Все изменения привязвки дивайса к клиенту будут сохраняться для последующего анализа и аудита. Каждая запись об изменении должна включать:
  - `id` (связь с user_id)
  - `old_device_id`
  - `new_device_id`
  - `timestamp`


### Таблица форматов уведомлений в зависимости от роли

| Роль              | Email                            | Push                             | Telegram/VK                     |
|-------------------|----------------------------------|----------------------------------|----------------------------------|
| Пользователь      | `{subject} \| {type}`            | `{subject}`                      | `Тема: {subject} \| {type}\nMessage content` |
| Модератор         | `{subject} \| {type}`            | `{subject} \| {type}`                     | `Тема: {subject} \| {type}\nMessage content` |
| Администратор     | `{subject} \| {type}`            | `{subject} \| {type}`                     | `Тема: {subject} \| {type}\nMessage content` |

### Варианты ошибок
- **400 Bad Request**: Ошибка в формате запроса или указание неверного сервиса.
- **404 Not Found**: Пользователь не найден или UUID не привязан.
- **500 Internal Server Error**: Внутренняя ошибка сервера, не удалось выполнить запрос.

### Примечания
- Уведомления отправляются в зависимости от выбранного сервиса и формата, специфичного для каждой платформы.
- UUID для Telegram и VK должен быть предварительно связан с пользователем через бота.
- При повторой отправке запроса на привязки по UUID должна быть произведена перезапись в базе данных на новый service_user_id.
- В случае изменения токена устройства (например, при переустановке приложения), мобильное приложение должно повторно отправить запрос на подписку с новым `device_id`.
- Для отправки push уведомлений и по почте, необходимо использовать сторонний сервис: условие - бепсплатный периуд или же бесплатная подписка, в будушем возможна оформление подписки. Так же необходимо наличие возможности оплаты через рф.
  - Пример: https://onesignal.com (с бесплатной подпиской) а так же push4site.com(с пробным периудом подписки), так же можно использовать иные сервисы при обнаружении подобных.
  - Необходимо согласовать сервис для отправки уведомлений с фронтендером.

